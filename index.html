<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intercomunicador Web - Sistema de Comunicaci√≥n</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Reset y Variables CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Container Principal */
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--surface-color);
            box-shadow: var(--shadow-lg);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo i {
            font-size: 1.75rem;
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger-color);
            animation: blink 1.5s infinite;
        }

        .status-indicator.connected {
            background: var(--success-color);
            animation: none;
        }

        .status-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            padding: 1.5rem;
            flex: 1;
        }

        /* Chat Container */
        .chat-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .messages-area {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: linear-gradient(to bottom, #f1f5f9, #ffffff);
        }

        .system-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--secondary-color);
            font-size: 0.875rem;
            padding: 0.75rem;
            background: var(--background-color);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            max-width: 80%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        .message.sent {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.voice {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border-left: 4px solid #047857;
        }

        .message.quick {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
            border-left: 4px solid #b45309;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Controls Panel */
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .controls-panel > div {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .controls-panel h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        /* Quick Messages */
        .quick-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .quick-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .quick-btn:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .quick-btn i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        /* Voice Controls */
        .voice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .voice-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 1rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .voice-btn.secondary {
            background: linear-gradient(135deg, var(--secondary-color), #475569);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            animation: pulse 1s infinite;
        }

        .voice-btn.muted {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .voice-btn i {
            font-size: 1.25rem;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .volume-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Text Chat */
        .message-input-container {
            display: flex;
            gap: 0.75rem;
        }

        .message-input-container input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .message-input-container input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .message-input-container button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 48px;
        }

        .message-input-container button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Status Bar */
        .status-bar {
            background: var(--background-color);
            border-top: 1px solid var(--border-color);
            padding: 1rem 2rem;
        }

        .status-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-info > span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 400px auto;
            }
            
            .controls-panel {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                grid-template-rows: auto;
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .main-content {
                padding: 1rem;
                gap: 1rem;
            }
            
            .messages-area {
                height: 300px;
            }
            
            .quick-buttons {
                grid-template-columns: 1fr;
            }
            
            .voice-buttons {
                grid-template-columns: 1fr;
            }
            
            .status-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                min-height: 100vh;
            }
            
            .logo h1 {
                font-size: 1.25rem;
            }
            
            .controls-panel {
                grid-template-columns: 1fr;
            }
            
            .controls-panel > div {
                padding: 1rem;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #0f172a;
                --surface-color: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --border-color: #334155;
            }
            
            .messages-area {
                background: linear-gradient(to bottom, #1e293b, #0f172a);
            }
            
            .message.received {
                background: var(--border-color);
                color: var(--text-primary);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-broadcast-tower"></i>
                    <h1>Intercomunicador</h1>
                </div>
                <div class="connection-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span class="status-text" id="statusText">Desconectado</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Chat Messages Area -->
            <div class="chat-container">
                <div class="messages-area" id="messagesArea">
                    <div class="system-message">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <div>Sistema iniciado. Listo para comunicaci√≥n.</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;" id="initTime"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <!-- Quick Messages -->
                <div class="quick-messages">
                    <h3><i class="fas fa-robot"></i> Mensajes R√°pidos</h3>
                    <div class="quick-buttons">
                        <button class="quick-btn" data-message="üöö Transporte pendiente - Revisar √°rea de entrega">
                            <i class="fas fa-truck"></i>
                            Transporte Pendiente
                        </button>
                        <button class="quick-btn" data-message="üì¶ Nuevo pedido recibido - Preparar para despacho">
                            <i class="fas fa-box"></i>
                            Nuevo Pedido
                        </button>
                        <button class="quick-btn" data-message="‚ö†Ô∏è Atenci√≥n requerida en √°rea principal">
                            <i class="fas fa-exclamation-triangle"></i>
                            Atenci√≥n Requerida
                        </button>
                        <button class="quick-btn" data-message="‚úÖ Trabajo completado - Listo para siguiente tarea">
                            <i class="fas fa-check-circle"></i>
                            Trabajo Completado
                        </button>
                        <button class="quick-btn" data-message="üçΩÔ∏è Hora de almuerzo - 30 minutos">
                            <i class="fas fa-utensils"></i>
                            Hora de Almuerzo
                        </button>
                        <button class="quick-btn" data-message="üîß Mantenimiento en progreso - Evitar √°rea">
                            <i class="fas fa-tools"></i>
                            Mantenimiento
                        </button>
                    </div>
                </div>

                <!-- Voice Controls -->
                <div class="voice-controls">
                    <h3><i class="fas fa-microphone"></i> Control de Voz</h3>
                    <div class="voice-buttons">
                        <button class="voice-btn" id="startRecording">
                            <i class="fas fa-microphone"></i>
                            <span>Mantener para Hablar</span>
                        </button>
                        <button class="voice-btn secondary" id="toggleMute">
                            <i class="fas fa-volume-up"></i>
                            <span>Audio ON</span>
                        </button>
                    </div>
                    <div class="volume-control">
                        <label for="volumeSlider">
                            <i class="fas fa-volume-down"></i>
                        </label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="80">
                        <label>
                            <i class="fas fa-volume-up"></i>
                        </label>
                    </div>
                </div>

                <!-- Text Chat -->
                <div class="text-chat">
                    <h3><i class="fas fa-comments"></i> Chat de Texto</h3>
                    <div class="message-input-container">
                        <input type="text" id="messageInput" placeholder="Escribir mensaje...">
                        <button id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-info">
                <span class="device-info">
                    <i class="fas fa-desktop"></i>
                    <span id="deviceType">PC</span>
                </span>
                <span class="users-count">
                    <i class="fas fa-users"></i>
                    <span id="usersCount">0</span> conectados
                </span>
                <span class="audio-status">
                    <i class="fas fa-signal" id="audioQuality"></i>
                    <span id="audioStatus">Sin audio</span>
                </span>
            </div>
        </footer>
    </div>

    <!-- Audio Elements -->
    <audio id="localAudio" muted></audio>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // Intercomunicador Web - Sistema de Comunicaci√≥n
        class IntercomunicadorApp {
            constructor() {
                this.isConnected = false;
                this.isRecording = false;
                this.isMuted = false;
                this.localStream = null;
                this.remoteStream = null;
                this.peerConnection = null;
                this.socket = null;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.connectedUsers = 0;
                
                // Configuraci√≥n WebRTC
                this.rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                this.init();
            }
            
            async init() {
                try {
                    this.setupEventListeners();
                    this.detectDeviceType();
                    this.setInitialTime();
                    await this.setupAudio();
                    this.setupWebSocket();
                    this.updateUI();
                    
                    console.log('Intercomunicador iniciado correctamente');
                } catch (error) {
                    console.error('Error iniciando la aplicaci√≥n:', error);
                    this.showError('Error iniciando la aplicaci√≥n');
                }
            }

            setInitialTime() {
                const initTimeElement = document.getElementById('initTime');
                const currentTime = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                if (initTimeElement) {
                    initTimeElement.textContent = currentTime;
                }
            }
            
            setupEventListeners() {
                // Botones de mensajes r√°pidos
                document.querySelectorAll('.quick-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const message = e.currentTarget.dataset.message;
                        this.sendQuickMessage(message);
                    });
                });
                
                // Control de voz
                const startRecordingBtn = document.getElementById('startRecording');
                const toggleMuteBtn = document.getElementById('toggleMute');
                const volumeSlider = document.getElementById('volumeSlider');
                
                // Mantener presionado para hablar
                startRecordingBtn.addEventListener('mousedown', () => this.startRecording());
                startRecordingBtn.addEventListener('mouseup', () => this.stopRecording());
                startRecordingBtn.addEventListener('mouseleave', () => this.stopRecording());
                
                // Touch events para m√≥viles
                startRecordingBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startRecording();
                });
                startRecordingBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopRecording();
                });
                
                toggleMuteBtn.addEventListener('click', () => this.toggleMute());
                volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
                
                // Chat de texto
                const messageInput = document.getElementById('messageInput');
                const sendMessageBtn = document.getElementById('sendMessage');
                
                sendMessageBtn.addEventListener('click', () => this.sendTextMessage());
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendTextMessage();
                    }
                });
                
                // Prevenir el comportamiento por defecto del formulario
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            }
            
            detectDeviceType() {
                const deviceTypeElement = document.getElementById('deviceType');
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (/mobile|android|iphone/.test(userAgent)) {
                    deviceTypeElement.textContent = 'M√≥vil';
                    deviceTypeElement.parentElement.innerHTML = '<i class="fas fa-mobile-alt"></i><span>M√≥vil</span>';
                } else if (/tablet|ipad/.test(userAgent)) {
                    deviceTypeElement.textContent = 'Tablet';
                    deviceTypeElement.parentElement.innerHTML = '<i class="fas fa-tablet-alt"></i><span>Tablet</span>';
                } else {
                    deviceTypeElement.textContent = 'PC';
                    deviceTypeElement.parentElement.innerHTML = '<i class="fas fa-desktop"></i><span>PC</span>';
                }
            }
            
            async setupAudio() {
                try {
                    // Solicitar permisos de micr√≥fono
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    const localAudio = document.getElementById('localAudio');
                    if (localAudio) {
                        localAudio.srcObject = this.localStream;
                    }
                    
                    this.updateAudioStatus('Micr√≥fono listo');
                    console.log('Audio configurado correctamente');
                    
                } catch (error) {
                    console.error('Error accediendo al micr√≥fono:', error);
                    this.updateAudioStatus('Sin micr√≥fono');
                    this.showError('No se pudo acceder al micr√≥fono. La funcionalidad de voz estar√° limitada.');
                }
            }
            
            setupWebSocket() {
                // Simulaci√≥n de WebSocket para demo
                // En producci√≥n, usar un servidor WebSocket real
                setTimeout(() => {
                    this.isConnected = true;
                    this.connectedUsers = Math.floor(Math.random() * 5) + 1;
                    this.updateConnectionStatus();
                    this.addSystemMessage('Conectado al sistema de intercomunicaci√≥n');
                }, 2000);
                
                // Simular otros usuarios conect√°ndose
                setInterval(() => {
                    if (this.isConnected) {
                        this.connectedUsers = Math.floor(Math.random() * 8) + 1;
                        this.updateUsersCount();
                    }
                }, 15000);
            }
            
            async startRecording() {
                if (this.isRecording || !this.localStream) return;
                
                try {
                    this.isRecording = true;
                    this.audioChunks = [];
                    
                    this.mediaRecorder = new MediaRecorder(this.localStream);
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.processRecording();
                    };
                    
                    this.mediaRecorder.start();
                    this.updateRecordingUI(true);
                    this.updateAudioStatus('Grabando...');
                    
                    // Efecto visual de grabaci√≥n
                    this.startRecordingAnimation();
                    
                } catch (error) {
                    console.error('Error iniciando grabaci√≥n:', error);
                    this.showError('Error al iniciar la grabaci√≥n');
                    this.isRecording = false;
                }
            }
            
            stopRecording() {
                if (!this.isRecording || !this.mediaRecorder) return;
                
                this.isRecording = false;
                this.mediaRecorder.stop();
                this.updateRecordingUI(false);
                this.stopRecordingAnimation();
                this.updateAudioStatus('Procesando audio...');
            }
            
            processRecording() {
                if (this.audioChunks.length === 0) return;
                
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                
                // Simular env√≠o de audio
                this.sendVoiceMessage();
                this.updateAudioStatus('Audio enviado');
                
                setTimeout(() => {
                    this.updateAudioStatus('Micr√≥fono listo');
                }, 2000);
            }
            
            sendVoiceMessage() {
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const message = `
                    <div class="message voice sent">
                        <div><i class="fas fa-microphone"></i> Mensaje de voz enviado</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
                
                this.addMessageToChat(message);
                this.playNotificationSound();
                
                // Simular respuesta autom√°tica
                setTimeout(() => {
                    this.simulateResponse('Mensaje de voz recibido correctamente');
                }, 1500);
            }
            
            sendTextMessage() {
                const messageInput = document.getElementById('messageInput');
                const text = messageInput.value.trim();
                
                if (!text) return;
                
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const message = `
                    <div class="message sent">
                        <div>${this.escapeHtml(text)}</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
                
                this.addMessageToChat(message);
                messageInput.value = '';
                this.playNotificationSound();
                
                // Simular respuesta autom√°tica para demo
                if (text.toLowerCase().includes('hola')) {
                    setTimeout(() => {
                        this.simulateResponse('¬°Hola! Sistema de intercomunicaci√≥n activo.');
                    }, 1000);
                }
            }
            
            sendQuickMessage(message) {
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const messageHtml = `
                    <div class="message quick sent">
                        <div><i class="fas fa-robot"></i> ${this.escapeHtml(message)}</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
                
                this.addMessageToChat(messageHtml);
                this.playNotificationSound();
                
                // Simular confirmaci√≥n
                setTimeout(() => {
                    this.simulateResponse('Mensaje autom√°tico transmitido a todas las √°reas');
                }, 1000);
            }
            
            simulateResponse(text) {
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const message = `
                    <div class="message received">
                        <div><i class="fas fa-headset"></i> ${this.escapeHtml(text)}</div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
                
                this.addMessageToChat(message);
                this.playNotificationSound();
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !this.isMuted;
                    });
                }
                
                const toggleBtn = document.getElementById('toggleMute');
                const icon = toggleBtn.querySelector('i');
                const text = toggleBtn.querySelector('span');
                
                if (this.isMuted) {
                    toggleBtn.classList.add('muted');
                    icon.className = 'fas fa-volume-mute';
                    text.textContent = 'Audio OFF';
                    this.updateAudioStatus('Audio silenciado');
                } else {
                    toggleBtn.classList.remove('muted');
                    icon.className = 'fas fa-volume-up';
                    text.textContent = 'Audio ON';
                    this.updateAudioStatus('Audio activo');
                }
            }
            
            setVolume(value) {
                const remoteAudio = document.getElementById('remoteAudio');
                if (remoteAudio) {
                    remoteAudio.volume = value / 100;
                }
                
                const audioQuality = document.getElementById('audioQuality');
                if (audioQuality) {
                    if (value > 70) {
                        audioQuality.className = 'fas fa-signal';
                        audioQuality.style.opacity = '1';
                    } else if (value > 30) {
                        audioQuality.className = 'fas fa-signal';
                        audioQuality.style.opacity = '0.7';
                    } else {
                        audioQuality.className = 'fas fa-signal';
                        audioQuality.style.opacity = '0.4';
                    }
                }
            }
            
            addMessageToChat(messageHtml) {
                const messagesArea = document.getElementById('messagesArea');
                if (messagesArea) {
                    messagesArea.insertAdjacentHTML('beforeend', messageHtml);
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }
            }
            
            addSystemMessage(text) {
                const timestamp = new Date().toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const message = `
                    <div class="system-message">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <div>${this.escapeHtml(text)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">${timestamp}</div>
                        </div>
                    </div>
                `;
                
                this.addMessageToChat(message);
            }
            
            updateConnectionStatus() {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (this.isConnected) {
                    statusIndicator.classList.add('connected');
                    statusText.textContent = 'Conectado';
                } else {
                    statusIndicator.classList.remove('connected');
                    statusText.textContent = 'Desconectado';
                }
            }
            
            updateUsersCount() {
                const usersCount = document.getElementById('usersCount');
                if (usersCount) {
                    usersCount.textContent = this.connectedUsers;
                }
            }
            
            updateAudioStatus(status) {
                const audioStatus = document.getElementById('audioStatus');
                if (audioStatus) {
                    audioStatus.textContent = status;
                }
            }
            
            updateRecordingUI(isRecording) {
                const startRecordingBtn = document.getElementById('startRecording');
                
                if (isRecording) {
                    startRecordingBtn.classList.add('recording');
                    startRecordingBtn.querySelector('span').textContent = 'Grabando...';
                } else {
                    startRecordingBtn.classList.remove('recording');
                    startRecordingBtn.querySelector('span').textContent = 'Mantener para Hablar';
                }
            }
            
            startRecordingAnimation() {
                // Agregar efecto visual durante la grabaci√≥n
                document.body.style.setProperty('--recording-glow', '0 0 20px rgba(239, 68, 68, 0.5)');
            }
            
            stopRecordingAnimation() {
                document.body.style.removeProperty('--recording-glow');
            }
            
            playNotificationSound() {
                // Crear sonido de notificaci√≥n usando AudioContext
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('No se pudo reproducir el sonido de notificaci√≥n');
                }
            }
            
            updateUI() {
                this.updateConnectionStatus();
                this.updateUsersCount();
                this.updateAudioStatus('Inicializando...');
                
                // Configurar volumen inicial
                const volumeSlider = document.getElementById('volumeSlider');
                if (volumeSlider) {
                    this.setVolume(volumeSlider.value);
                }
            }
            
            showError(message) {
                const errorMessage = `
                    <div class="system-message" style="border-left-color: var(--danger-color); background: rgba(239, 68, 68, 0.1);">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                        <div>
                            <div style="color: var(--danger-color);">${this.escapeHtml(message)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                                ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;
                
                this.addMessageToChat(errorMessage);
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            window.intercomunicador = new IntercomunicadorApp();
            
            // Manejar visibilidad de la p√°gina
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('Aplicaci√≥n en segundo plano');
                } else {
                    console.log('Aplicaci√≥n en primer plano');
                }
            });
            
            // Manejar desconexi√≥n
            window.addEventListener('beforeunload', () => {
                if (window.intercomunicador) {
                    // Limpiar recursos
                    if (window.intercomunicador.localStream) {
                        window.intercomunicador.localStream.getTracks().forEach(track => {
                            track.stop();
                        });
                    }
                }
            });
        });

        // Service Worker para funcionamiento offline (opcional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registrado:', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed:', registrationError);
                    });
            });
        }
    </script>
</body>
</html>